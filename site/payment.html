<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Оплата — VPN_GPT</title>
  <style>
    :root {
      --bg: #0b1020;
      --text: #e0e8ff;
      --muted: #9daed3;
      --accent: #5ac8fa;
      --accent-2: #9b8cff;
      --radius: 14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      line-height: 1.6;
    }
    a { color: var(--accent); text-decoration: none; }
    header {
      padding: 20px 0;
      position: sticky;
      top: 0;
      background: rgba(11, 16, 32, 0.9);
      backdrop-filter: blur(8px);
    }
    .container { width: min(960px, 92%); margin: auto; }
    .nav { display: flex; justify-content: space-between; align-items: center; }
    .brand { font-weight: 700; letter-spacing: .3px; display: flex; align-items: center; gap: 10px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); }
    .nav a { color: var(--muted); font-size: 14px; margin-left: 20px; }
    .hero { padding: 80px 0 40px; text-align: center; }
    .hero h1 { font-size: clamp(28px, 4vw, 44px); font-weight: 700; line-height: 1.2; margin-bottom: 16px; }
    .hero p { color: var(--muted); font-size: 18px; margin-bottom: 32px; }
    .payment-form { max-width: 420px; margin: 0 auto; background: #101730; padding: 28px; border-radius: var(--radius); border: 1px solid rgba(255, 255, 255, 0.08); text-align: left; display: flex; flex-direction: column; gap: 22px; }
    .payment-form label { display: block; margin-bottom: 8px; color: var(--muted); font-size: 14px; }
    .payment-form input,
    .payment-form select { width: 100%; padding: 12px; background: #0b1020; color: var(--text); border: 1px solid rgba(195, 255, 255, 0.12); border-radius: var(--radius); margin-bottom: 18px; font-size: 15px; transition: border-color .2s ease; }
    .payment-form input:focus,
    .payment-form select:focus { outline: none; border-color: var(--accent); }
    .payment-form input::placeholder { color: rgba(224, 232, 255, 0.6); }
    .btn { display: inline-block; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #02142a; padding: 14px 28px; border-radius: var(--radius); font-weight: 700; transition: .2s; text-align: center; border: none; cursor: pointer; width: 100%; }
    .btn[disabled] { opacity: .6; cursor: wait; }
    .btn:hover:not([disabled]) { opacity: .9; }
    .status { margin-top: 18px; font-size: 14px; color: var(--muted); min-height: 20px; }
    .status.success { color: #7fffd4; }
    .status.error { color: #ff7b7b; }
    .stars-block { border: 1px solid rgba(90, 200, 250, 0.35); border-radius: var(--radius); padding: 20px; background: rgba(90, 200, 250, 0.08); position: relative; }
    .stars-block[hidden] { display: none; }
    .stars-heading { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
    .stars-icon { width: 36px; height: 36px; display: grid; place-items: center; border-radius: 50%; background: rgba(90, 200, 250, 0.14); font-size: 20px; }
    .stars-title { font-size: 18px; font-weight: 600; margin: 0; }
    .stars-description { font-size: 13px; color: var(--muted); margin-top: 2px; }
    .stars-buttons { display: grid; gap: 12px; margin-top: 12px; }
    .stars-btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: rgba(90, 200, 250, 0.16); color: var(--text); border: 1px solid rgba(90, 200, 250, 0.4); padding: 12px 18px; border-radius: var(--radius); font-weight: 600; transition: transform .15s ease, background .2s ease; width: 100%; text-align: center; }
    .stars-btn--subscription { background: rgba(155, 140, 255, 0.18); border-color: rgba(155, 140, 255, 0.45); }
    .stars-btn:hover { background: rgba(90, 200, 250, 0.22); transform: translateY(-1px); }
    .stars-btn--subscription:hover { background: rgba(155, 140, 255, 0.26); }
    .stars-btn:active { transform: translateY(0); }
    .stars-btn span { white-space: nowrap; }
    .stars-note { font-size: 12px; color: rgba(224, 232, 255, 0.7); margin-top: 10px; line-height: 1.5; }
    .stars-status { margin-top: 12px; font-size: 13px; min-height: 18px; color: var(--muted); }
    .stars-status.error { color: #ff7b7b; }
    .stars-status.success { color: #7fffd4; }
    @media (max-width: 540px) {
      .payment-form { padding: 24px; }
      .stars-heading { align-items: flex-start; }
    }
    footer { padding: 40px 0; color: var(--muted); font-size: 14px; text-align: center; border-top: 1px solid rgba(255, 255, 255, 0.05); margin-top: 60px; }
    .footer-links a { margin: 0 8px; font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand"><span class="dot"></span><span>VPN_GPT</span></div>
      <nav>
        <a href="index.html#features">Возможности</a>
        <a href="index.html#how">Как работает</a>
        <a href="index.html#pricing">Тарифы</a>
        <a href="index.html#contacts">Контакты</a>
      </nav>
    </div>
  </header>
  <section class="hero">
    <div class="container">
      <h1>Оплата подписки</h1>
      <p>Все тарифы VPN_GPT оформляются по подписке Telegram Stars: вы выбираете срок, а оплата повторяется автоматически до отмены.</p>
      <div class="payment-form">
        <div class="status" style="margin-bottom:12px">
          Оплата картой временно недоступна. Используйте Telegram Stars — это безопасно и происходит прямо внутри мессенджера.
        </div>
        <div class="stars-block" id="stars-section" aria-live="polite">
          <div class="stars-heading">
            <div class="stars-icon" aria-hidden="true">⭐️</div>
            <div>
              <p class="stars-title">Оплатить звёздами в Telegram</p>
              <p class="stars-description">После оплаты бот мгновенно выдаст или продлит доступ. Все планы — подписки с автопродлением: 1 месяц — 80⭐, 3 месяца — 200⭐, 12 месяцев — 700⭐.</p>
            </div>
          </div>
          <div class="stars-buttons" id="stars-buttons"></div>
          <p class="stars-note">Если у вас ещё нет звёзд, Telegram предложит купить их перед оплатой — это займёт пару минут. Управлять подпиской можно прямо в приложении Telegram: переходите в Настройки → Telegram Premium → Управление подписками.</p>
          <div class="stars-status" id="stars-status"></div>
        </div>
      </div>
    </div>
  </section>
  <footer>
    <div class="container">
      © <span id="py"></span> VPN_GPT · AI‑помощник по подбору VPN.
      <div class="footer-links" style="margin-top:20px">
        <a href="privacy.html">Политика конфиденциальности</a> ·
        <a href="refund.html">Политика возврата</a> ·
        <a href="offer.html">Публичная оферта</a>
      </div>
    </div>
  </footer>
  <script>
    document.getElementById('py').textContent = new Date().getFullYear();

    const starsButtons = document.getElementById('stars-buttons');
    const starsStatus = document.getElementById('stars-status');

    const formatStars = (value) => {
      const number = Number(value);
      if (!Number.isFinite(number)) {
        return `${value}⭐`;
      }
      return `${number.toLocaleString('ru-RU')}⭐`;
    };

    const createStarsButton = (invoice) => {
      const link = document.createElement('a');
      link.className = `stars-btn${invoice.is_subscription ? ' stars-btn--subscription' : ''}`;
      link.href = invoice.link;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.dataset.plan = invoice.plan;
      const priceText = invoice.is_subscription
        ? `${formatStars(invoice.price_stars)}/${formatPeriod(invoice.duration_days)}`
        : formatStars(invoice.price_stars);
      link.innerHTML = `<span>⭐</span><span>${invoice.title}</span><span>${priceText}</span>`;
      return link;
    };

    const formatPeriod = (durationDays) => {
      if (durationDays === 30) return 'мес';
      if (durationDays === 90) return '3 мес';
      if (durationDays === 180) return '6 мес';
      if (durationDays === 365 || durationDays === 360) return 'год';
      if (durationDays === 1) return 'день';
      return `${durationDays} дн`;
    };

    const setStarsStatus = (text, type) => {
      if (!starsStatus) return;
      starsStatus.textContent = text || '';
      starsStatus.classList.remove('error', 'success');
      if (type) starsStatus.classList.add(type);
    };

    const loadStarInvoices = async () => {
      if (!starsButtons) {
        return;
      }

      try {
        setStarsStatus('Загружаем доступные тарифы…');
        const response = await fetch('/api/stars/invoices', {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
        });
        if (!response.ok) {
          throw new Error(response.statusText || `HTTP ${response.status}`);
        }
        const data = await response.json();
        if (!data?.enabled) {
          setStarsStatus('Оплата звёздами временно недоступна. Напишите нам в Telegram — поможем вручную.', 'error');
          return;
        }

        starsButtons.innerHTML = '';
        const order = ['test_1d', '1m', '3m', '1y'];
        const plans = data.plans || {};
        let added = 0;
        order.forEach((code) => {
          const invoice = plans[code];
          if (!invoice) return;
          starsButtons.appendChild(createStarsButton(invoice));
          added += 1;
        });
        Object.keys(plans)
          .filter((code) => !order.includes(code))
          .sort()
          .forEach((code) => {
            const invoice = plans[code];
            starsButtons.appendChild(createStarsButton(invoice));
            added += 1;
          });

        if (added === 0) {
          setStarsStatus('Пока нет доступных тарифов для оплаты звёздами.', 'error');
        } else {
          setStarsStatus('Выберите подписку — оплата звёздами проходит прямо в Telegram.', 'success');
        }
      } catch (error) {
        console.error(error);
        setStarsStatus('Не удалось загрузить оплату звёздами. Попробуйте позже или напишите нам в Telegram.', 'error');
      }
    };

    loadStarInvoices();
  </script>
</body>
</html>
